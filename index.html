<script>
console.log("âœ… Script loaded â€” starting Descubro visualization...");

// Capture any silent issues
window.addEventListener("error", e => {
  console.error("ðŸš¨ JS Error:", e.message, e.filename, e.lineno);
});
window.addEventListener("unhandledrejection", e => {
  console.error("ðŸš¨ Promise Rejection:", e.reason);
});

const width = window.innerWidth;
const height = window.innerHeight;

const svg = d3.select("body").append("svg")
  .attr("width", width)
  .attr("height", height)
  .style("background", "#fafafa");

// ðŸ‘‡ TEMP: add proxy to bypass CORS for testing
const proxy = "https://cors-anywhere.herokuapp.com/";
const artistAPI = proxy + "https://alexjmiller95.bubbleapps.io/version-test/api/1.1/obj/Artist";
const connectionAPI = proxy + "https://alexjmiller95.bubbleapps.io/version-test/api/1.1/obj/ArtistConnection?limit=500";

console.log("ðŸ” Testing API fetch...");
console.log("ðŸŽ¯ Artist API:", artistAPI);
console.log("ðŸŽ¯ Connection API:", connectionAPI);

// Make sure fetch actually runs
Promise.all([
  fetch(artistAPI)
    .then(res => {
      console.log("ðŸ§  Artist fetch response:", res.status, res.statusText);
      return res.json();
    }),
  fetch(connectionAPI)
    .then(res => {
      console.log("ðŸ”— Connection fetch response:", res.status, res.statusText);
      return res.json();
    })
])
.then(([artistData, connectionData]) => {
  console.log("âœ… API responses received!");
  console.log("ðŸŽ¨ Artists data:", artistData);
  console.log("ðŸ”— Connections data:", connectionData);

  const artists = artistData?.response?.results || [];
  const connections = connectionData?.response?.results || [];

  if (!artists.length) {
    console.warn("âš ï¸ No artist data found.");
    return;
  }

  const nodes = artists.map(a => ({
    id: a._id,
    name: a.name_text || "(no name)",
    genre: a.genre || "Unknown"
  }));

  const color = d3.scaleOrdinal(d3.schemeSet2);

  const node = svg.selectAll("circle")
    .data(nodes)
    .join("circle")
    .attr("cx", (_, i) => 50 + i * 25)
    .attr("cy", height / 2)
    .attr("r", 8)
    .attr("fill", (_, i) => color(i));

  svg.selectAll("text")
    .data(nodes)
    .join("text")
    .attr("x", (_, i) => 50 + i * 25)
    .attr("y", height / 2 + 25)
    .text(d => d.name)
    .attr("font-size", "10px")
    .attr("text-anchor", "middle");

  console.log(`ðŸ§© Rendered ${nodes.length} artists on screen`);
})
.catch(err => {
  console.error("ðŸš¨ Fetch or visualization error:", err);
});
</script>
