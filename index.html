<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Descubro ‚Äî Artist Genre Network</title>

  <!-- ‚úÖ Load Google Font: Afacad -->
  <link href="https://fonts.googleapis.com/css2?family=Afacad:wght@400;600&display=swap" rel="stylesheet">

  <!-- ‚úÖ Load D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #121212;
      color: #fff;
      font-family: 'Afacad', 'Poppins', sans-serif;
    }

    text {
      font-size: 12px;
      fill: #ddd;
      pointer-events: none;
    }

    circle {
      stroke: #121212;
      stroke-width: 1px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    circle:hover {
      transform: scale(1.25);
    }

    line {
      stroke: #888;
      stroke-opacity: 0.5;
    }

    #loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      color: #ff7a00;
      text-align: center;
    }

    #loader::after {
      content: "";
      display: block;
      width: 40px;
      height: 40px;
      margin: 12px auto;
      border-radius: 50%;
      border: 5px solid #ff7a00;
      border-color: #ff7a00 transparent #ff7a00 transparent;
      animation: spin 1.2s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .tooltip {
      position: absolute;
      background: #1f1f1f;
      padding: 6px 8px;
      border: 1px solid #333;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      font-size: 12px;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      transition: opacity 0.3s ease;
    }

    .legend text {
      fill: #ccc;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div id="loader">Loading artist network...</div>

  <script>
    console.log("‚úÖ Script loaded ‚Äî starting Descubro visualization...");

    const width = window.innerWidth;
    const height = window.innerHeight;

    const svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);

    const artistAPI = "https://alexjmiller95.bubbleapps.io/version-test/api/1.1/obj/Artist";

    // üß† Fetch artists
    fetch(artistAPI)
      .then(res => res.json())
      .then(data => {
        document.getElementById("loader").style.display = "none";

        const artists = data?.response?.results || [];
        if (!artists.length) {
          console.warn("‚ö†Ô∏è No artist data found.");
          return;
        }

        // üß© Build genre list
        const genreMap = {};
        artists.forEach(a => {
          const genres = (a.genres_list || a.genre || "").split(",").map(g => g.trim()).filter(Boolean);
          genreMap[a._id] = genres;
        });

        // üé® Collect unique genres
        const allGenres = Array.from(new Set(Object.values(genreMap).flat()));
        const color = d3.scaleOrdinal(d3.schemeTableau10).domain(allGenres);

        // üß† Create nodes
        const nodes = artists.map(a => ({
          id: a._id,
          name: a.name_text || "(no name)",
          genres: genreMap[a._id] || []
        }));

        // üîó Create links where artists share at least one genre
        const links = [];
        for (let i = 0; i < nodes.length; i++) {
          for (let j = i + 1; j < nodes.length; j++) {
            const shared = nodes[i].genres.filter(g => nodes[j].genres.includes(g));
            if (shared.length > 0) {
              links.push({
                source: nodes[i].id,
                target: nodes[j].id,
                sharedGenres: shared
              });
            }
          }
        }

        console.log("üß© Artists:", nodes.length, " Links:", links.length);

        // üß≤ Simulation
        const simulation = d3.forceSimulation(nodes)
          .force("link", d3.forceLink(links).id(d => d.id).distance(120))
          .force("charge", d3.forceManyBody().strength(-200))
          .force("center", d3.forceCenter(width / 2, height / 2))
          .force("collision", d3.forceCollide(20));

        // Draw links
        const link = svg.append("g")
          .attr("stroke", "#666")
          .attr("stroke-opacity", 0.4)
          .selectAll("line")
          .data(links)
          .join("line")
          .attr("stroke-width", 1);

        // Draw nodes
        const node = svg.append("g")
          .selectAll("circle")
          .data(nodes)
          .join("circle")
          .attr("r", 8)
          .attr("fill", d => color(d.genres[0] || "Other"))
          .call(drag(simulation))
          .on("mouseover", (event, d) => showTooltip(event, d))
          .on("mouseout", hideTooltip);

        // Add labels
        const label = svg.append("g")
          .selectAll("text")
          .data(nodes)
          .join("text")
          .text(d => d.name)
          .attr("font-size", 11)
          .attr("x", 10)
          .attr("y", 3);

        // Tooltip
        const tooltip = d3.select("body").append("div")
          .attr("class", "tooltip");

        function showTooltip(event, d) {
          tooltip.transition().duration(200).style("opacity", 1);
          tooltip.html(`<strong>${d.name}</strong><br>Genres: ${d.genres.join(", ") || "None"}`)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 20) + "px");
        }

        function hideTooltip() {
          tooltip.transition().duration(200).style("opacity", 0);
        }

        // Update positions on tick
        simulation.on("tick", () => {
          link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

          node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);

          label
            .attr("x", d => d.x + 10)
            .attr("y", d => d.y + 3);
        });

        // Drag behavior
        function drag(simulation) {
          function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
          }
          function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
          }
          function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
          }
          return d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended);
        }

        // üßæ Genre legend
        const legend = svg.append("g")
          .attr("class", "legend")
          .attr("transform", "translate(20, 20)");

        allGenres.forEach((g, i) => {
          const y = i * 22;
          legend.append("circle")
            .attr("cx", 0)
            .attr("cy", y)
            .attr("r", 6)
            .attr("fill", color(g));
          legend.append("text")
            .attr("x", 12)
            .attr("y", y + 4)
            .text(g);
        });
      })
      .catch(err => {
        document.getElementById("loader").textContent = "‚ö†Ô∏è Failed to load data.";
        console.error("üö® Fetch or visualization error:", err);
      });
  </script>
</body>
</html>
