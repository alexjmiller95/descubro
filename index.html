<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Descubro â€” Artist Network</title>

  <!-- Afacad font -->
  <link href="https://fonts.googleapis.com/css2?family=Afacad:wght@400;600&display=swap" rel="stylesheet">

  <!-- D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #121212;
      color: #fff;
      font-family: 'Afacad', 'Poppins', sans-serif;
    }

    text {
      font-size: 12px;
      fill: #ddd;
      pointer-events: none;
    }

    circle {
      stroke: #121212;
      stroke-width: 1px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    circle:hover {
      transform: scale(1.25);
    }

    line {
      stroke-opacity: 0.5;
    }

    #loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      color: #ff7a00;
      text-align: center;
    }

    #loader::after {
      content: "";
      display: block;
      width: 40px;
      height: 40px;
      margin: 12px auto;
      border-radius: 50%;
      border: 5px solid #ff7a00;
      border-color: #ff7a00 transparent #ff7a00 transparent;
      animation: spin 1.2s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .tooltip {
      position: absolute;
      background: #1f1f1f;
      padding: 6px 8px;
      border: 1px solid #333;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      font-size: 12px;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      transition: opacity 0.3s ease;
    }

    .legend text {
      fill: #ccc;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div id="loader">Loading artist network...</div>

  <script>
console.log("ðŸ§  Debug mode: starting Descubro visualization...");

const width = window.innerWidth;
const height = window.innerHeight;
const svg = d3.select("body").append("svg")
  .attr("width", width)
  .attr("height", height);

const artistAPI = "https://alexjmiller95.bubbleapps.io/version-test/api/1.1/obj/Artist";
const connectionAPI = "https://alexjmiller95.bubbleapps.io/version-test/api/1.1/obj/ArtistConnection?limit=500";

Promise.all([
  fetch(artistAPI).then(res => res.json()),
  fetch(connectionAPI).then(res => res.json())
])
.then(([artistData, connectionData]) => {
  const artistsRaw = artistData?.response?.results || [];
  const connectionsRaw = connectionData?.response?.results || [];

  console.log("ðŸŽ§ Artists fetched:", artistsRaw.length, artistsRaw.slice(0, 3));
  console.log("ðŸŽµ Connections fetched:", connectionsRaw.length, connectionsRaw.slice(0, 3));

  const clean = str => str ? str.trim().toLowerCase() : "";

  // Step 1: Build artist map
  const artistMap = new Map();
  artistsRaw.forEach(a => {
    const name = clean(a.name_text);
    if (!name) return;
    artistMap.set(name, { id: name, name: a.name_text.trim(), raw: a });
  });

  console.log("ðŸ“˜ Artist names in map:", Array.from(artistMap.keys()).slice(0, 10));

  // Step 2: Check connection matches
  let missingSource = 0;
  let missingTarget = 0;
  const debugLinks = [];

  connectionsRaw.forEach(c => {
    const s = clean(c.artist_1);
    const t = clean(c.artist_2);
    const hasS = artistMap.has(s);
    const hasT = artistMap.has(t);

    if (!hasS || !hasT) {
      console.warn("âš ï¸ Missing artist in map:",
        { artist_1: c.artist_1, artist_2: c.artist_2, hasS, hasT });
      if (!hasS) missingSource++;
      if (!hasT) missingTarget++;
    } else {
      debugLinks.push({ source: s, target: t });
    }
  });

  console.log(`âœ… Links matched successfully: ${debugLinks.length}`);
  console.log(`âŒ Missing source artists: ${missingSource}`);
  console.log(`âŒ Missing target artists: ${missingTarget}`);

  if (debugLinks.length === 0) {
    console.error("ðŸš¨ ZERO LINKS FOUND â€” name mismatch between ArtistConnection and Artist datasets.");
    console.log("ðŸ’¡ Example keys in artistMap:", Array.from(artistMap.keys()).slice(0, 10));
    console.log("ðŸ’¡ Example artist_1 from connection data:", connectionsRaw[0]?.artist_1);
    console.log("ðŸ’¡ Example artist_2 from connection data:", connectionsRaw[0]?.artist_2);
  } else {
    console.log("ðŸ”— First 5 matched links:", debugLinks.slice(0, 5));
  }

  // You can stop here â€” no need to render while debugging
})
.catch(err => console.error("ðŸš¨ Fetch or parsing error:", err));
</script>
