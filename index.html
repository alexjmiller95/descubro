<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Descubro â€” Artist Network</title>

  <!-- Afacad font -->
  <link href="https://fonts.googleapis.com/css2?family=Afacad:wght@400;600&display=swap" rel="stylesheet">

  <!-- D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #121212;
      color: #fff;
      font-family: 'Afacad', 'Poppins', sans-serif;
    }

    text {
      font-size: 12px;
      fill: #ddd;
      pointer-events: none;
    }

    circle {
      stroke: #121212;
      stroke-width: 1px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    circle:hover {
      transform: scale(1.25);
    }

    line {
      stroke-opacity: 0.5;
    }

    #loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      color: #ff7a00;
      text-align: center;
    }

    #loader::after {
      content: "";
      display: block;
      width: 40px;
      height: 40px;
      margin: 12px auto;
      border-radius: 50%;
      border: 5px solid #ff7a00;
      border-color: #ff7a00 transparent #ff7a00 transparent;
      animation: spin 1.2s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .tooltip {
      position: absolute;
      background: #1f1f1f;
      padding: 6px 8px;
      border: 1px solid #333;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      font-size: 12px;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      transition: opacity 0.3s ease;
    }

    .legend text {
      fill: #ccc;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div id="loader">Loading artist network...</div>

  <script>
console.log("ðŸ§  Debug mode (Bubble object fields) â€” starting Descubro visualization...");

const artistAPI = "https://alexjmiller95.bubbleapps.io/version-test/api/1.1/obj/Artist";
const connectionAPI = "https://alexjmiller95.bubbleapps.io/version-test/api/1.1/obj/ArtistConnection?limit=500";

Promise.all([
  fetch(artistAPI).then(res => res.json()),
  fetch(connectionAPI).then(res => res.json())
])
.then(([artistData, connectionData]) => {
  const artistsRaw = artistData?.response?.results || [];
  const connectionsRaw = connectionData?.response?.results || [];

  console.log("ðŸŽ§ Artists fetched:", artistsRaw.length, artistsRaw.slice(0, 3));
  console.log("ðŸŽµ Connections fetched:", connectionsRaw.length, connectionsRaw.slice(0, 3));

  const clean = str => str ? str.trim().toLowerCase() : "";

  // Artist map
  const artistMap = new Map();
  artistsRaw.forEach(a => {
    const name = clean(a.name_text);
    if (!name) return;
    artistMap.set(name, { id: name, name: a.name_text });
  });

  console.log("ðŸ“˜ Sample artistMap keys:", Array.from(artistMap.keys()).slice(0, 10));

  // Check connection fields
  connectionsRaw.forEach(c => {
    console.log("ðŸ” Connection raw artist_1:", c.artist_1);
    console.log("ðŸ” Connection raw artist_2:", c.artist_2);
  });

  // Extract links using correct Bubble field structure
  const links = connectionsRaw.map(c => {
    const a1 = typeof c.artist_1 === "object" ? c.artist_1.display : c.artist_1;
    const a2 = typeof c.artist_2 === "object" ? c.artist_2.display : c.artist_2;
    return {
      source: clean(a1),
      target: clean(a2),
      genre: c.genre || "other"
    };
  });

  console.log("ðŸ§© Extracted sample links:", links.slice(0, 5));

  const matched = links.filter(l => artistMap.has(l.source) && artistMap.has(l.target));
  const missing = links.filter(l => !artistMap.has(l.source) || !artistMap.has(l.target));

  console.log(`âœ… Matched links: ${matched.length}`);
  console.warn(`âš ï¸ Missing links: ${missing.length}`);

  if (missing.length > 0) {
    console.warn("Example missing links:", missing.slice(0, 5));
  }
})
.catch(err => console.error("ðŸš¨ Fetch or parsing error:", err));
</script>
